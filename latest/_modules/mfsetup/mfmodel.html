<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mfsetup.mfmodel &mdash; modflow-setup 0.4.0.post1+g6fadcf0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/documentation_options.js?v=343ba67d"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            modflow-setup
          </a>
              <div class="version">
                0.4.0.post1+g6fadcf0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../philosophy.html">     Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html"> Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10min.html"> 10 Minutes to Modflow-setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html"> Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config-file-gallery.html"> Configuration File Gallery</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../structure.html"> Basic program structure and usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config-file.html"> The configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/index.html"> Concepts and methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html"> Input instructions by package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html"> Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html"> Code reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config-file-defaults.html"> Configuration file defaults</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-history.html"> Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html"> Contributing to modflow-setup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bibliography</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html#modflow-setup-applications">Modflow-setup applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html#workflow-examples">Workflow examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">modflow-setup</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mfsetup.mfmodel</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mfsetup.mfmodel</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">flopy</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pyproj</span>
<span class="kn">from</span> <span class="nn">packaging</span> <span class="kn">import</span> <span class="n">version</span>

<span class="n">fm</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span>
<span class="n">mf6</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span>
<span class="kn">import</span> <span class="nn">gisutils</span>
<span class="kn">import</span> <span class="nn">sfrmaker</span>
<span class="kn">from</span> <span class="nn">gisutils</span> <span class="kn">import</span> <span class="n">get_shapefile_crs</span><span class="p">,</span> <span class="n">get_values_at_points</span><span class="p">,</span> <span class="n">project</span>
<span class="kn">from</span> <span class="nn">sfrmaker</span> <span class="kn">import</span> <span class="n">Lines</span>
<span class="kn">from</span> <span class="nn">sfrmaker.utils</span> <span class="kn">import</span> <span class="n">assign_layers</span>

<span class="kn">from</span> <span class="nn">mfsetup.bcs</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_bc_package_cells</span><span class="p">,</span>
    <span class="n">setup_basic_stress_data</span><span class="p">,</span>
    <span class="n">setup_flopy_stress_period_data</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mfsetup.config</span> <span class="kn">import</span> <span class="n">validate_configuration</span>
<span class="kn">from</span> <span class="nn">mfsetup.fileio</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">check_source_files</span><span class="p">,</span>
    <span class="n">load</span><span class="p">,</span>
    <span class="n">load_array</span><span class="p">,</span>
    <span class="n">load_cfg</span><span class="p">,</span>
    <span class="n">save_array</span><span class="p">,</span>
    <span class="n">set_cfg_paths_to_absolute</span><span class="p">,</span>
    <span class="n">setup_external_filepaths</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mfsetup.grid</span> <span class="kn">import</span> <span class="n">MFsetupGrid</span><span class="p">,</span> <span class="n">get_ij</span><span class="p">,</span> <span class="n">rasterize</span><span class="p">,</span> <span class="n">setup_structured_grid</span>
<span class="kn">from</span> <span class="nn">mfsetup.interpolate</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_source_dest_model_xys</span><span class="p">,</span>
    <span class="n">interp_weights</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="p">,</span>
    <span class="n">regrid</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mfsetup.lakes</span> <span class="kn">import</span> <span class="n">make_lakarr2d</span><span class="p">,</span> <span class="n">setup_lake_fluxes</span><span class="p">,</span> <span class="n">setup_lake_info</span>
<span class="kn">from</span> <span class="nn">mfsetup.mf5to6</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_model_length_units</span><span class="p">,</span>
    <span class="n">get_model_time_units</span><span class="p">,</span>
    <span class="n">get_package_name</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mfsetup.model_version</span> <span class="kn">import</span> <span class="n">get_versions</span>
<span class="kn">from</span> <span class="nn">mfsetup.sourcedata</span> <span class="kn">import</span> <span class="n">TransientTabularSourceData</span><span class="p">,</span> <span class="n">setup_array</span>
<span class="kn">from</span> <span class="nn">mfsetup.tdis</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">concat_periodata_groups</span><span class="p">,</span>
    <span class="n">get_parent_stress_periods</span><span class="p">,</span>
    <span class="n">parse_perioddata_groups</span><span class="p">,</span>
    <span class="n">setup_perioddata</span><span class="p">,</span>
    <span class="n">setup_perioddata_group</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mfsetup.tmr</span> <span class="kn">import</span> <span class="n">Tmr</span>
<span class="kn">from</span> <span class="nn">mfsetup.units</span> <span class="kn">import</span> <span class="n">convert_length_units</span><span class="p">,</span> <span class="n">lenuni_text</span><span class="p">,</span> <span class="n">lenuni_values</span>
<span class="kn">from</span> <span class="nn">mfsetup.utils</span> <span class="kn">import</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">get_input_arguments</span><span class="p">,</span> <span class="n">get_packages</span><span class="p">,</span> <span class="n">update</span>
<span class="kn">from</span> <span class="nn">mfsetup.wells</span> <span class="kn">import</span> <span class="n">setup_wel_data</span>

<span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">gisutils</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;0.2.2&#39;</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Automatic reprojection functionality requires gis-utils &gt;= 0.2.2&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Please pip install --upgrade gis-utils&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sfrmaker</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;0.6&#39;</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;sfr: sfrmaker_options: add_outlet functionality requires sfrmaker &gt;= 0.6&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Please pip install --upgrade sfrmaker&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="MFsetupMixin">
<a class="viewcode-back" href="../../api/mfsetup.mfmodel.html#mfsetup.mfmodel.MFsetupMixin">[docs]</a>
<span class="k">class</span> <span class="nc">MFsetupMixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mixin class for shared functionality between MF6model and MFnwtModel.</span>
<span class="sd">    Meant to be inherited by both those classes and not be called directly.</span>

<span class="sd">    https://stackoverflow.com/questions/533631/what-is-a-mixin-and-why-are-they-useful</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;        -1 : well</span>
<span class="sd">        0 : no lake</span>
<span class="sd">        1 : lak package lake (lakarr &gt; 0)</span>
<span class="sd">        2 : high-k lake</span>
<span class="sd">        3 : ghb</span>
<span class="sd">        4 : sfr&quot;&quot;&quot;</span>
    <span class="c1"># package variable name: number</span>
    <span class="n">bc_numbers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wel&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                  <span class="s1">&#39;lak&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="s1">&#39;high-k lake&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="s1">&#39;ghb&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                  <span class="s1">&#39;sfr&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                  <span class="s1">&#39;riv&#39;</span><span class="p">:</span> <span class="mi">5</span>
                  <span class="p">}</span>
    <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;mfsetup&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>

        <span class="c1"># property attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_perioddata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelgrid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bbox</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_default_source_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lakarr_2d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isbc_2d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lakarr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isbc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lake_bathymetry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_high_k_lake_recharge</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodata_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_ws</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abs_model_ws</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_version</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># semantic version of model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_longname</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># long name for model (short name is self.name)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># header for files and repr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inset</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># dictionary of inset models attached to LGR parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_lgr</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># flag for lgr inset models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lgr</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># holds flopy Lgr utility object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmr</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># holds TMR class instance for TMR-type perimeter boundaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># whether model is being made or loaded from existing files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lake_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lake_fluxes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># flopy settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mg_resync</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary for caching shapefile datasets in memory</span>

        <span class="c1"># arrays remade during this session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_arrays</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># cache of interpolation weights to speed up regridding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interp_weights</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;Parent model: </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelgrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_modelgrid</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;Packages:&#39;</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_package_list</span><span class="p">():</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nper</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1"> period(s):</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perioddata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;start_datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;end_datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;perlen&#39;</span><span class="p">,</span> <span class="s1">&#39;steady&#39;</span><span class="p">,</span> <span class="s1">&#39;nstp&#39;</span><span class="p">]</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perioddata</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   ...</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perioddata</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="n">tail</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">txt</span>
        <span class="k">return</span> <span class="n">txt</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for equality to another model object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># kludge: skip obs packages for now</span>
        <span class="c1"># - obs packages aren&#39;t read in with same name under which they were created</span>
        <span class="c1"># - also SFR_OBS package is handled by SFRmaker instead of Flopy;</span>
        <span class="c1"># a loaded version of a model might have SFR_OBS,</span>
        <span class="c1"># where a freshly made version may not (even though SFRmaker will write it)</span>
        <span class="c1">#</span>
        <span class="n">all_packages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_package_list</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">get_package_list</span><span class="p">())</span>
        <span class="n">exceptions</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">all_packages</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">)</span>
                      <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">)}</span>
        <span class="n">other_packages</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">get_package_list</span><span class="p">())</span>
                          <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">]</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_package_list</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">other_packages</span> <span class="o">!=</span> <span class="n">packages</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">modelgrid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">nlay</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlay</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">perioddata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">perioddata</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1">#  TODO: add checks of actual array values and other parameters</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cfg&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;sfrdata&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;_load&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;_packagelist&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;_package_paths&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;package_key_dict&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;package_type_dict&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;package_name_dict&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;_ftype_num_dict&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;cfg&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="k">pass</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perioddata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perioddata</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;structured&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">nrow</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s1">&#39;structured&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">ncol</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">modelgrid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelgrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_grid</span><span class="p">()</span>
        <span class="c1"># trap for instance where default (base) modelgrid</span>
        <span class="c1"># instance is attached to the flopy model</span>
        <span class="c1"># (because the grid hasn&#39;t been set up with)</span>
        <span class="c1"># self._modelgrid.nlay will error in this case</span>
        <span class="c1"># because of NotImplementedError in base class</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelgrid</span><span class="o">.</span><span class="n">grid_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelgrid</span><span class="o">.</span><span class="n">nlay</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;DIS&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_package_list</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_grid</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelgrid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bbox</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">bbox</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bbox</span>

    <span class="c1">#@property</span>
    <span class="c1">#def perioddata(self):</span>
    <span class="c1">#    &quot;&quot;&quot;DataFrame summarizing stress period information.</span>
<span class="c1">#</span>
    <span class="c1">#    Columns:</span>
<span class="c1">#</span>
    <span class="c1">#      start_date_time : pandas datetimes; start date/time of each stress period</span>
    <span class="c1">#      (does not include steady-state periods)</span>
    <span class="c1">#      end_date_time : pandas datetimes; end date/time of each stress period</span>
    <span class="c1">#      (does not include steady-state periods)</span>
    <span class="c1">#      time : float; cumulative MODFLOW time (includes steady-state periods)</span>
    <span class="c1">#      per : zero-based stress period</span>
    <span class="c1">#      perlen : stress period length in model time units</span>
    <span class="c1">#      nstp : number of timesteps in the stress period</span>
    <span class="c1">#      tsmult : timestep multiplier for stress period</span>
    <span class="c1">#      steady : True=steady-state, False=Transient</span>
    <span class="c1">#      oc : MODFLOW-6 output control options</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    if self._perioddata is None:</span>
    <span class="c1">#        perioddata = setup_perioddata(self)</span>
    <span class="c1">#    return self._perioddata</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mapping between layers in source model and</span>
<span class="sd">        layers in destination model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        parent_layers : dict</span>
<span class="sd">            {inset layer : parent layer}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parent_layers</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">botm_source_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;botm&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inset_layer_mapping&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parent_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inset_layer_mapping&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">botm_source_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;from_parent&#39;</span> <span class="ow">in</span> <span class="n">botm_source_data</span><span class="p">:</span>
                <span class="n">parent_layers</span> <span class="o">=</span> <span class="n">botm_source_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_parent&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parent_layers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">nlay</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">nlay</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#parent_layers = dict(zip(range(self.parent.modelgrid.nlay), range(self.parent.modelgrid.nlay)))</span>
                <span class="n">parent_layers</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_layers</span> <span class="o">=</span> <span class="n">parent_layers</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_layers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent_stress_periods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mapping between stress periods in source model and</span>
<span class="sd">        stress periods in destination model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        parent_stress_periods : dict</span>
<span class="sd">            {inset stress period : parent stress period}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;parent_sp&#39;</span><span class="p">]))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">package_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Definitive list of packages. Get from namefile input first</span>
<span class="sd">        (as in mf6 input), then look under model input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nam&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;packages&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">packages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">packages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;packages&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_package_setup_order</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">perimeter_bc_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dictates how perimeter boundaries are set up.</span>

<span class="sd">        if &#39;head&#39;; a constant head package is created</span>
<span class="sd">            from the parent model starting heads</span>
<span class="sd">        if &#39;flux&#39;; a specified flux boundary is created</span>
<span class="sd">            from parent model cell by cell flow output</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="n">perimeter_boundary_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perimeter_boundary_type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">perimeter_boundary_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;head&#39;</span> <span class="ow">in</span> <span class="n">perimeter_boundary_type</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;head&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;flux&#39;</span> <span class="ow">in</span> <span class="n">perimeter_boundary_type</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;flux&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model_ws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model_ws</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_model_ws</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ws</span>

    <span class="nd">@model_ws</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">model_ws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_ws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_ws</span> <span class="o">=</span> <span class="n">model_ws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abs_model_ws</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">model_ws</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Semantic version of model, using a hacked version of the versioneer.</span>
<span class="sd">        Version is reported using git tags for the model repository</span>
<span class="sd">        or a start_version: key specified in the configuration file (default 0).</span>
<span class="sd">        The start_version or tag is then appended by the remaining information</span>
<span class="sd">        in a pep440-post style version tag (e.g. most recent git commit hash</span>
<span class="sd">        for the model repository + &quot;dirty&quot; if the model repository has uncommited changes)</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        https://github.com/warner/python-versioneer</span>
<span class="sd">        https://github.com/warner/python-versioneer/blob/master/details.md</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model_version</span> <span class="o">=</span> <span class="n">get_versions</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                   <span class="n">start_version</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;start_version&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_version</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">longname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">longname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;longname&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">longname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">longname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> model&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_longname</span> <span class="o">=</span> <span class="n">longname</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longname</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">version_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
            <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">longname</span><span class="si">}</span><span class="s1"> version </span><span class="si">{</span><span class="n">version_str</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">header</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tmpdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#abspath = os.path.abspath(</span>
        <span class="c1">#        self.cfg[&#39;intermediate_data&#39;][&#39;output_folder&#39;])</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_ws</span> <span class="o">/</span> <span class="s1">&#39;original-arrays&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;intermediate_data&#39;</span><span class="p">][</span><span class="s1">&#39;output_folder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="n">abspath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#if not os.path.isdir(abspath):</span>
        <span class="c1">#    os.makedirs(abspath)</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">abspath</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_external_paths</span><span class="p">:</span>
            <span class="c1">#tmpdir = os.path.relpath(abspath)</span>
            <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">abspath</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="c1">#else:</span>
        <span class="c1">#   do we need to normalize with Pathlib??</span>
        <span class="c1">#    tmpdir = os.path.normpath(abspath)</span>
        <span class="k">return</span> <span class="n">tmpdir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">external_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;external_path&#39;</span><span class="p">,</span> <span class="s1">&#39;external&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_external_paths</span><span class="p">:</span>
            <span class="n">ext_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ext_path</span>

    <span class="nd">@external_path</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">external_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">pass</span> <span class="c1"># bypass any setting in parent class</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">interp_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For a given parent, only calculate interpolation weights</span>
<span class="sd">        once to speed up re-gridding of arrays to pfl_nwt.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parent_xy</span><span class="p">,</span> <span class="n">inset_xy</span> <span class="o">=</span> <span class="n">get_source_dest_model_xys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                                                                        <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interp_weights</span> <span class="o">=</span> <span class="n">interp_weights</span><span class="p">(</span><span class="n">parent_xy</span><span class="p">,</span> <span class="n">inset_xy</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp_weights</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Boolean array indicating window in parent model grid (subset of cells)</span>
<span class="sd">        that encompass the inset model domain, with a surrounding buffer.</span>
<span class="sd">        Used to speed up interpolation of parent grid values onto inset model grid.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>
            <span class="n">pi</span><span class="p">,</span> <span class="n">pj</span> <span class="o">=</span> <span class="n">get_ij</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">pi</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">pad</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">pi</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">pad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">nrow</span><span class="p">])</span>
            <span class="n">j0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">pj</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">pad</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">j1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">pj</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">pad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">ncol</span><span class="p">])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span> <span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_mask</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nlakes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lakarr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lakarr</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_lakarr2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;2-D array of areal extent of lakes. Non-zero values</span>
<span class="sd">        correspond to lak package IDs.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lakarr_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_lakarr2d</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lakarr_2d</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lakarr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;3-D array of lake extents in each layer. Non-zero values</span>
<span class="sd">        correspond to lak package IDs. Extent of lake in</span>
<span class="sd">        each layer is based on bathymetry and model layer thickness.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lakarr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_external_filepaths</span><span class="p">(</span><span class="s1">&#39;lak&#39;</span><span class="p">,</span> <span class="s1">&#39;lakarr&#39;</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;lak&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_filename_fmt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;lakarr&#39;</span><span class="p">)],</span>
                                          <span class="n">file_numbers</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlay</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isbc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_lakarr</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lakarr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_isbc2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;2-D array indicating the i, j locations of</span>
<span class="sd">        boundary conditions.</span>
<span class="sd">        -1 : well</span>
<span class="sd">        0 : no lake</span>
<span class="sd">        1 : lak package lake (lakarr &gt; 0)</span>
<span class="sd">        2 : high-k lake</span>
<span class="sd">        3 : ghb</span>
<span class="sd">        4 : sfr</span>
<span class="sd">        5 : riv</span>

<span class="sd">        see also the .bc_numbers attibute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isbc_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_isbc2d</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isbc_2d</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isbc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;3D array indicating which cells have a lake in each layer.</span>
<span class="sd">        -1 : well</span>
<span class="sd">        0 : no lake</span>
<span class="sd">        1 : lak package lake (lakarr &gt; 0)</span>
<span class="sd">        2 : high-k lake</span>
<span class="sd">        3 : ghb</span>
<span class="sd">        4 : sfr</span>
<span class="sd">        5 : riv</span>

<span class="sd">        see also the .bc_numbers attibute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># DIS package is needed to set up the isbc array</span>
        <span class="c1"># (to compare lake bottom elevations to layer bottoms)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_package</span><span class="p">(</span><span class="s1">&#39;dis&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isbc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_isbc</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isbc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lake_bathymetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Put lake bathymetry setup logic here instead of DIS package.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lake_bathymetry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_lake_bathymetry</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lake_bathymetry</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">high_k_lake_recharge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recharge value to apply to high-K lakes, in model units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high_k_lake_recharge</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;high_k_lakes&#39;</span><span class="p">][</span><span class="s1">&#39;simulate_high_k_lakes&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lake_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lake_info</span> <span class="o">=</span> <span class="n">setup_lake_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lake_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lake_fluxes</span> <span class="o">=</span> <span class="n">setup_lake_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="s1">&#39;high_k_lakes&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_high_k_lake_recharge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lake_fluxes</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;per&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s1">&#39;highk_lake_rech&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high_k_lake_recharge</span>

    <span class="k">def</span> <span class="nf">load_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">load_array</span><span class="p">(</span><span class="n">f</span><span class="p">,</span>
                                         <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span>
                                         <span class="n">nodata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodata_value</span>
                                         <span class="p">)</span>
                              <span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">load_array</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>

<div class="viewcode-block" id="MFsetupMixin.load_features">
<a class="viewcode-back" href="../../api/mfsetup.mfmodel.html#mfsetup.mfmodel.MFsetupMixin.load_features">[docs]</a>
    <span class="k">def</span> <span class="nf">load_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">bbox_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">id_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load vector and attribute data from a shapefile;</span>
<span class="sd">        cache it to the _features dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">features_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span><span class="p">]</span>

        <span class="n">dfs_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="n">features_crs</span> <span class="o">=</span> <span class="n">get_shapefile_crs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="c1">#try:</span>
                    <span class="c1">#    from gisutils import get_shapefile_crs</span>
                    <span class="c1">#    features_crs = get_shapefile_crs(kwargs[&#39;shapefile&#39;])</span>
                    <span class="c1">#except Exception as e:</span>
                    <span class="c1">#    features_crs = pyproj.crs.CRS.from_proj4(get_proj_str(f))</span>
                    <span class="c1">#authority = features_crs.to_authority()</span>
                    <span class="c1">#if authority is not None:</span>
                    <span class="c1">#    features_crs = pyproj.CRS.from_user_input(features_crs.to_authority())</span>
                    <span class="k">if</span> <span class="n">bbox_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">bbox</span>
                            <span class="n">model_crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">crs</span>
                            <span class="k">assert</span> <span class="n">model_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">features_crs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                            <span class="n">bbox_filter</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">features_crs</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">bbox_filter</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>

                    <span class="c1"># implement automatic reprojection in gis-utils</span>
                    <span class="c1"># maintaining backwards compatibility</span>
                    <span class="c1">#kwargs = {&#39;dest_crs&#39;: self.modelgrid.crs}</span>
                    <span class="c1">#kwargs = get_input_arguments(kwargs, shp2df)</span>
                    <span class="c1">#df = shp2df(f, filter=filter, **kwargs)</span>
                    <span class="c1">#df.columns = [c.lower() for c in df.columns]</span>
                    <span class="c1">#if &#39;dest_crs&#39; not in kwargs and features_crs != self.modelgrid.crs:</span>
                    <span class="c1">#    df[&#39;geometry&#39;] = project(df[&#39;geometry&#39;], features_crs, self.modelgrid.crs)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;caching data in </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;feature input file </span><span class="si">{}</span><span class="s1"> not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">id_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">id_column</span> <span class="o">=</span> <span class="n">id_column</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="c1"># convert any floating point dtypes to integer</span>
                <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">id_column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">id_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_column</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">include_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">include_ids</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">dfs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No features loaded from </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="MFsetupMixin.get_boundary_cells">
<a class="viewcode-back" href="../../api/mfsetup.mfmodel.html#mfsetup.mfmodel.MFsetupMixin.get_boundary_cells">[docs]</a>
    <span class="k">def</span> <span class="nf">get_boundary_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude_inactive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the i, j locations of cells along the model perimeter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        k, i, j : 1D numpy arrays of ints</span>
<span class="sd">            zero-based layer, row, column locations of boundary cells</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># top row, right side, left side, bottom row</span>
        <span class="n">i_top</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span>
        <span class="n">j_top</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
        <span class="n">i_left</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">j_left</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">i_right</span> <span class="o">=</span> <span class="n">i_left</span>
        <span class="n">j_right</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">i_botm</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span>
        <span class="n">j_botm</span> <span class="o">=</span> <span class="n">j_top</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i_top</span> <span class="o">+</span> <span class="n">i_left</span> <span class="o">+</span> <span class="n">i_right</span> <span class="o">+</span> <span class="n">i_botm</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">j_top</span> <span class="o">+</span> <span class="n">j_left</span> <span class="o">+</span> <span class="n">j_right</span> <span class="o">+</span> <span class="n">j_botm</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span> <span class="o">-</span> <span class="mi">4</span>
        <span class="n">nlaycells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlay</span><span class="p">))</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlay</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlay</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="n">nlaycells</span><span class="p">:</span><span class="n">nlaycells</span> <span class="o">*</span> <span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="n">nlaycells</span>

        <span class="k">if</span> <span class="n">exclude_inactive</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                <span class="n">active_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idomain</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">active_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">active_cells</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">active_cells</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="n">active_cells</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></div>


<div class="viewcode-block" id="MFsetupMixin.regrid_from_parent">
<a class="viewcode-back" href="../../api/mfsetup.mfmodel.html#mfsetup.mfmodel.MFsetupMixin.regrid_from_parent">[docs]</a>
    <span class="k">def</span> <span class="nf">regrid_from_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_array</span><span class="p">,</span>
                           <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Interpolate values in parent array onto</span>
<span class="sd">        the pfl_nwt model grid, using model grid instances</span>
<span class="sd">        attached to the parent and pfl_nwt models.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parent_array : ndarray</span>
<span class="sd">            Values from parent model to be interpolated to pfl_nwt grid.</span>
<span class="sd">            1 or 2-D numpy array of same sizes as a</span>
<span class="sd">            layer of the parent model.</span>
<span class="sd">        mask : ndarray (bool)</span>
<span class="sd">            1 or 2-D numpy array of same sizes as a</span>
<span class="sd">            layer of the parent model. True values</span>
<span class="sd">            indicate cells to include in interpolation,</span>
<span class="sd">            False values indicate cells that will be</span>
<span class="sd">            dropped.</span>
<span class="sd">        method : str (&#39;linear&#39;, &#39;nearest&#39;)</span>
<span class="sd">            Interpolation method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">regrid</span><span class="p">(</span><span class="n">parent_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="p">,</span>
                          <span class="n">mask1</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                          <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="c1">#parent_values = parent_array.flatten()[self.parent_mask.flatten()]</span>
            <span class="n">parent_values</span> <span class="o">=</span> <span class="n">parent_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_mask</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">regridded</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">parent_values</span><span class="p">,</span>
                                    <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_weights</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">:</span>
            <span class="n">regridded</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">(</span><span class="n">parent_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="p">,</span>
                               <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">regridded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">regridded</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">regridded</span></div>


<div class="viewcode-block" id="MFsetupMixin.setup_external_filepaths">
<a class="viewcode-back" href="../../api/mfsetup.mfmodel.html#mfsetup.mfmodel.MFsetupMixin.setup_external_filepaths">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_external_filepaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span>
                                 <span class="n">filename_format</span><span class="p">,</span> <span class="n">file_numbers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up external file paths for a MODFLOW package variable. Sets paths</span>
<span class="sd">        for intermediate files, which are written from the (processed) source data.</span>
<span class="sd">        Intermediate files are supplied to Flopy as external files for a given package</span>
<span class="sd">        variable. Flopy writes external files to a specified location when the MODFLOW</span>
<span class="sd">        package file is written. This method gets the external file paths that</span>
<span class="sd">        will be written by FloPy, and puts them in the configuration dictionary</span>
<span class="sd">        under their respective variables.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        package : str</span>
<span class="sd">            Three-letter package abreviation (e.g. &#39;DIS&#39; for discretization)</span>
<span class="sd">        variable_name : str</span>
<span class="sd">            FloPy name of variable represented by external files (e.g. &#39;top&#39; or &#39;botm&#39;)</span>
<span class="sd">        filename_format : str</span>
<span class="sd">            File path to the external file(s). Can be a string representing a single file</span>
<span class="sd">            (e.g. &#39;top.dat&#39;), or for variables where a file is written for each layer or</span>
<span class="sd">            stress period, a format string that will be formated with the zero-based layer</span>
<span class="sd">            number (e.g. &#39;botm{}.dat&#39;) for files botm0.dat, botm1.dat, ...</span>
<span class="sd">        file_numbers : list of ints</span>
<span class="sd">            List of numbers for the external files. Usually these represent zero-based</span>
<span class="sd">            layers or stress periods.</span>
<span class="sd">        relative_external_paths : bool</span>
<span class="sd">            If true, external paths will be specified relative to model_ws,</span>
<span class="sd">            otherwise, they will be absolute paths</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        filepaths : list</span>
<span class="sd">            List of external file paths</span>

<span class="sd">        Adds intermediated file paths to model.cfg[&lt;package&gt;][&#39;intermediate_data&#39;]</span>
<span class="sd">        Adds external file paths to model.cfg[&lt;package&gt;][&lt;variable_name&gt;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for lgr models, add the model name to the external filename</span>
        <span class="c1"># if lgr parent or lgr inset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgr</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_lgr</span><span class="p">:</span>
            <span class="n">filename_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">filename_format</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">setup_external_filepaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span>
                                        <span class="n">filename_format</span><span class="p">,</span> <span class="n">file_numbers</span><span class="o">=</span><span class="n">file_numbers</span><span class="p">,</span>
                                        <span class="n">relative_external_paths</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">relative_external_paths</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_model_ws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cfg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
            <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sim_ws&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_ws&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abs_model_ws</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>  <span class="c1"># within a session, modflow-setup operates in the model_ws</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_external_paths</span><span class="p">:</span>
            <span class="n">model_ws</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_ws</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_ws</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset_bc_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the boundary condition property arrays in order.</span>
<span class="sd">        _lakarr2d (depends on _lakarr_2d</span>
<span class="sd">        _isbc2d  (depends on _lakarr2d)</span>
<span class="sd">        _lake_bathymetry (depends on _isbc2d)</span>
<span class="sd">        _isbc  (depends on _isbc2d)</span>
<span class="sd">        _lakarr  (depends on _isbc and _lakarr2d)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lakarr_2d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isbc_2d</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#  (depends on _lakarr2d)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lake_bathymetry</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># (depends on _isbc2d)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isbc</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#  (depends on _isbc2d)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lakarr</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#</span>
        <span class="c1">#self._set_lakarr2d() # calls self._set_isbc2d(), which calls self._set_lake_bathymetry()</span>
        <span class="c1">#self._set_isbc() # calls self._set_lakarr()</span>

    <span class="k">def</span> <span class="nf">_set_cfg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_specified_cfg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load configuration file; update dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#self.cfg = defaultdict(dict)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_specified_cfg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_specified_cfg</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Configuration should have already been loaded&quot;</span><span class="p">)</span>
            <span class="c1"># convert to an absolute path</span>
            <span class="c1">#user_specified_cfg = Path(user_specified_cfg).resolve()</span>
            <span class="c1">#assert user_specified_cfg.exists(), \</span>
            <span class="c1">#    &quot;config file {} not found&quot;.format(user_specified_cfg)</span>
            <span class="c1">#updates = load(user_specified_cfg)</span>
            <span class="c1">#updates[&#39;filename&#39;] = user_specified_cfg</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_specified_cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">updates</span> <span class="o">=</span> <span class="n">user_specified_cfg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">user_specified_cfg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;unrecognized input for cfg&quot;</span><span class="p">)</span>

        <span class="c1"># if the user specifies a complexity option for IMS or NWT,</span>
        <span class="c1"># don&#39;t import any defaults</span>
        <span class="n">ims_cfg</span> <span class="o">=</span> <span class="n">updates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ims&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">ims_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;complexity&#39;</span><span class="p">):</span>
            <span class="c1"># delete the defaults</span>
            <span class="k">for</span> <span class="n">default_block</span> <span class="ow">in</span> <span class="s1">&#39;nonlinear&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">default_block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;ims&#39;</span><span class="p">]:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;ims&#39;</span><span class="p">][</span><span class="n">default_block</span><span class="p">]</span>
        <span class="n">nwt_cfg</span> <span class="o">=</span> <span class="n">updates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nwt&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">nwt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;specified&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;specified&#39;</span><span class="p">:</span>
            <span class="n">keep_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;headtol&#39;</span><span class="p">,</span> <span class="s1">&#39;fluxtol&#39;</span><span class="p">,</span> <span class="s1">&#39;maxiterout&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;thickfact&#39;</span><span class="p">,</span> <span class="s1">&#39;linmeth&#39;</span><span class="p">,</span> <span class="s1">&#39;iprnwt&#39;</span><span class="p">,</span> <span class="s1">&#39;ibotav&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Continue&#39;</span><span class="p">,</span> <span class="s1">&#39;use_existing_file&#39;</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;nwt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;nwt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keep_args</span><span class="p">}</span>

        <span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
        <span class="c1"># make sure empty variables get initialized as dicts</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;filename&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">:</span>
            <span class="n">config_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">config_file_path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">set_cfg_paths_to_absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="n">config_file_path</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

        <span class="c1"># mf6 models: set up or load the simulation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;simulation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;simulation&#39;</span><span class="p">][</span><span class="s1">&#39;options&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.nam&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sim_name&#39;</span><span class="p">]))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">mf6</span><span class="o">.</span><span class="n">MFSimulation</span><span class="o">.</span><span class="n">load</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sim</span> <span class="o">=</span> <span class="n">mf6</span><span class="o">.</span><span class="n">MFSimulation</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># create simulation</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">mf6</span><span class="o">.</span><span class="n">MFSimulation</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sim</span> <span class="o">=</span> <span class="n">mf6</span><span class="o">.</span><span class="n">MFSimulation</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># create simulation</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">mf6</span><span class="o">.</span><span class="n">MFSimulation</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sim</span> <span class="o">=</span> <span class="n">mf6</span><span class="o">.</span><span class="n">MFSimulation</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># load the parent model (skip if already attached)</span>
        <span class="k">if</span> <span class="s1">&#39;namefile&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">()</span>

        <span class="n">output_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;postprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;output_folders&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">folder_path</span> <span class="ow">in</span> <span class="n">output_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">_path&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">folder_path</span><span class="p">)</span>

        <span class="c1"># absolute path to config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># set package keys to default dicts</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_package_setup_order</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">pkg</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="p">{}))</span>

        <span class="c1"># other variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;external_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># validate the configuration</span>
        <span class="n">validate_configuration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_high_k_lakes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the i, j locations of any high-k lakes within the model grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lakesdata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lakes_shapefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;high_k_lakes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lakes_shapefile&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lakes_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lakes_shapefile</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">lakes_shapefile</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">lakes_shapefile</span><span class="p">}</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">lakes_shapefile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_features</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;include_ids&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># load all lakes in shapefile</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;include_ids&#39;</span><span class="p">)</span>
            <span class="n">lakesdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_features</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lakesdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_high_k_lake</span> <span class="o">=</span> <span class="n">rasterize</span><span class="p">(</span><span class="n">lakesdata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">is_high_k_lake</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_set_isbc2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the _isbc2d array, that indicates the i,j locations</span>
<span class="sd">        of boundary conditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">isbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># high-k lakes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;high_k_lakes&#39;</span><span class="p">][</span><span class="s1">&#39;simulate_high_k_lakes&#39;</span><span class="p">]:</span>
            <span class="n">is_high_k_lake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_high_k_lakes</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">is_high_k_lake</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">isbc</span><span class="p">[</span><span class="n">is_high_k_lake</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># lake package lakes</span>
        <span class="n">isbc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_lakarr2d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># add other bcs</span>
        <span class="k">for</span> <span class="n">packagename</span><span class="p">,</span> <span class="n">bcnumber</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_numbers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;lak&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">packagename</span><span class="p">:</span>
                <span class="n">package</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_package</span><span class="p">(</span><span class="n">packagename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">package</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># handle multiple instances of package</span>
                    <span class="c1"># (in MODFLOW-6)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">flopy</span><span class="o">.</span><span class="n">pakbase</span><span class="o">.</span><span class="n">PackageInterface</span><span class="p">):</span>
                        <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="n">package</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">packages</span> <span class="o">=</span> <span class="n">package</span>
                    <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
                        <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">get_bc_package_cells</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
                        <span class="n">not_a_lake</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">isbc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">not_a_lake</span><span class="p">]</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="n">not_a_lake</span><span class="p">]</span>
                        <span class="n">isbc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcnumber</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isbc_2d</span> <span class="o">=</span> <span class="n">isbc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_lake_bathymetry</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_isbc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">isbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nlay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">isbc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isbc2d</span>

            <span class="c1"># in mf6 models, the model top is set to the lake botm</span>
            <span class="c1"># and any layers originally above the lake botm</span>
            <span class="c1"># are also reset to the lake botm (given zero-thickness)</span>
            <span class="n">lake_botm_elevations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">array</span>
            <span class="n">below</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">botm</span><span class="o">.</span><span class="n">array</span> <span class="o">&gt;=</span> <span class="n">lake_botm_elevations</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                <span class="n">lake_botm_elevations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">array</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lake_bathymetry</span>
                <span class="n">layer_tops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">botm</span><span class="o">.</span><span class="n">array</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                <span class="c1"># lakes must be at least 10% into a layer to get simulated in that layer</span>
                <span class="n">below</span> <span class="o">=</span> <span class="n">layer_tops</span> <span class="o">&gt;</span> <span class="n">lake_botm_elevations</span> <span class="o">+</span> <span class="mf">0.1</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ibelow</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">below</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ibelow</span><span class="p">):</span>
                    <span class="n">isbc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">ibelow</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isbc2d</span><span class="p">[</span><span class="n">ibelow</span><span class="p">]</span>
            <span class="c1"># add other bcs</span>
            <span class="k">for</span> <span class="n">packagename</span><span class="p">,</span> <span class="n">bcnumber</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_numbers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;lak&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">packagename</span><span class="p">:</span>
                    <span class="n">package</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_package</span><span class="p">(</span><span class="n">packagename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">package</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># handle multiple instances of package</span>
                        <span class="c1"># (in MODFLOW-6)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">flopy</span><span class="o">.</span><span class="n">pakbase</span><span class="o">.</span><span class="n">PackageInterface</span><span class="p">):</span>
                            <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="n">package</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">packages</span> <span class="o">=</span> <span class="n">package</span>
                        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
                            <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">get_bc_package_cells</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
                            <span class="n">not_a_lake</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">isbc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">not_a_lake</span><span class="p">]</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">not_a_lake</span><span class="p">]</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="n">not_a_lake</span><span class="p">]</span>
                            <span class="n">isbc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcnumber</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_isbc</span> <span class="o">=</span> <span class="n">isbc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_lakarr</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_lakarr2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">lakarr2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;lak&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_list</span><span class="p">:</span>
                <span class="n">lakes_shapefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;lak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lakes_shapefile&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">lakes_shapefile</span><span class="p">:</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">lakes_shapefile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_features</span><span class="p">)</span>
                    <span class="n">lakesdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_features</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># caches loaded features</span>
                    <span class="n">lakes_shapefile</span><span class="p">[</span><span class="s1">&#39;lakesdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lakesdata</span>
                    <span class="n">lakes_shapefile</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">)</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">lakes_shapefile</span><span class="p">,</span> <span class="n">make_lakarr2d</span><span class="p">)</span>
                    <span class="n">lakarr2d</span> <span class="o">=</span> <span class="n">make_lakarr2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lakarr_2d</span> <span class="o">=</span> <span class="n">lakarr2d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_isbc2d</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_lakarr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_external_filepaths</span><span class="p">(</span><span class="s1">&#39;lak&#39;</span><span class="p">,</span> <span class="s1">&#39;lakarr&#39;</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;lak&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_filename_fmt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;lakarr&#39;</span><span class="p">)],</span>
                                      <span class="n">file_numbers</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlay</span><span class="p">)))</span>
        <span class="c1"># assign lakarr values from 3D isbc array</span>
        <span class="n">lakarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nlay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlay</span><span class="p">):</span>
            <span class="n">lakarr</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">isbc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lakarr2d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">isbc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ilakarr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lakarr</span><span class="p">):</span>
            <span class="n">save_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;intermediate_data&#39;</span><span class="p">][</span><span class="s1">&#39;lakarr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">ilakarr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lakarr</span> <span class="o">=</span> <span class="n">lakarr</span>

    <span class="k">def</span> <span class="nf">_set_lake_bathymetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bathymetry_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lak&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bathymetry_raster&#39;</span><span class="p">)</span>
        <span class="n">default_lake_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_lake_depth&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bathymetry_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lmult</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bathymetry_file</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">lmult</span> <span class="o">=</span> <span class="n">convert_length_units</span><span class="p">(</span><span class="n">bathymetry_file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;length_units&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">length_units</span><span class="p">)</span>
                <span class="n">bathymetry_file</span> <span class="o">=</span> <span class="n">bathymetry_file</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>

            <span class="c1"># sample pre-made bathymetry at grid points</span>
            <span class="n">bathy</span> <span class="o">=</span> <span class="n">get_values_at_points</span><span class="p">(</span><span class="n">bathymetry_file</span><span class="p">,</span>
                                         <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">xcellcenters</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                         <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">ycellcenters</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                         <span class="n">points_crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                                         <span class="n">out_of_bounds_errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
            <span class="n">bathy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bathy</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span> <span class="o">*</span> <span class="n">lmult</span>
            <span class="n">bathy</span><span class="p">[(</span><span class="n">bathy</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bathy</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># fill bathymetry grid in remaining lake cells with default lake depth</span>
            <span class="c1"># also ensure that all non lake cells have bathy=0</span>
            <span class="n">fill</span> <span class="o">=</span> <span class="p">(</span><span class="n">bathy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isbc2d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isbc2d</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">bathy</span><span class="p">[</span><span class="n">fill</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_lake_depth</span>
            <span class="n">bathy</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isbc2d</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isbc2d</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bathy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lake_bathymetry</span> <span class="o">=</span> <span class="n">bathy</span>

    <span class="k">def</span> <span class="nf">_set_parent_modelgrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mg_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the parent model grid from keyword arguments</span>
<span class="sd">        or existing modelgrid, and DIS package.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">mg_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mg_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xoff&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">xoffset</span><span class="p">,</span>
                      <span class="s1">&#39;yoff&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">yoffset</span><span class="p">,</span>
                      <span class="s1">&#39;angrot&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">angrot</span><span class="p">,</span>
                      <span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                      <span class="s1">&#39;epsg&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">epsg</span><span class="p">,</span>
                      <span class="c1">#&#39;proj4&#39;: self.parent.modelgrid.proj4,</span>
                      <span class="p">}</span>
        <span class="n">parent_units</span> <span class="o">=</span> <span class="n">get_model_length_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;lenuni&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]:</span>
            <span class="n">parent_units</span> <span class="o">=</span> <span class="n">lenuni_text</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">][</span><span class="s1">&#39;lenuni&#39;</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="s1">&#39;length_units&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]:</span>
            <span class="n">parent_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">][</span><span class="s1">&#39;length_units&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">length_units</span> <span class="o">=</span> <span class="n">parent_units</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">lenuni</span> <span class="o">=</span> <span class="n">lenuni_values</span><span class="p">[</span><span class="n">parent_units</span><span class="p">]</span>

        <span class="c1"># make sure crs is populated, then get CRS units for the grid</span>
        <span class="kn">from</span> <span class="nn">gisutils</span> <span class="kn">import</span> <span class="n">get_authority_crs</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;crs&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_authority_crs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;epsg&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_authority_crs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;epsg&#39;</span><span class="p">])</span>
        <span class="c1"># no parent CRS info, assume the parent model is in the same CRS</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;setup_grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;crs&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_authority_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;setup_grid&#39;</span><span class="p">][</span><span class="s1">&#39;crs&#39;</span><span class="p">])</span>
        <span class="c1"># no parent CRS info, assume the parent model is in the same CRS</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;setup_grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;epsg&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_authority_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;setup_grid&#39;</span><span class="p">][</span><span class="s1">&#39;epsg&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No coordinate reference input in setup_grid: or parent: &#39;</span>
                             <span class="s1">&#39;SpatialReference: blocks of configuration file. Supply &#39;</span>
                             <span class="s1">&#39;at least coordinate reference information to &#39;</span>
                             <span class="s1">&#39;setup_grid: crs: item.&#39;</span><span class="p">)</span>

        <span class="n">parent_grid_units</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit_name</span>

        <span class="k">if</span> <span class="s1">&#39;foot&#39;</span> <span class="ow">in</span> <span class="n">parent_grid_units</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;feet&#39;</span> <span class="ow">in</span> <span class="n">parent_grid_units</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">parent_grid_units</span> <span class="o">=</span> <span class="s1">&#39;feet&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;metre&#39;</span> <span class="ow">in</span> <span class="n">parent_grid_units</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;meter&#39;</span> <span class="ow">in</span> <span class="n">parent_grid_units</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">parent_grid_units</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unrecognized CRS units </span><span class="si">{</span><span class="n">parent_grid_units</span><span class="si">}</span><span class="s1">: CRS must be projected in feet or meters&#39;</span><span class="p">)</span>

        <span class="c1"># assume that model grid is in a projected CRS of meters</span>
        <span class="n">lmult</span> <span class="o">=</span> <span class="n">convert_length_units</span><span class="p">(</span><span class="n">parent_units</span><span class="p">,</span> <span class="n">parent_grid_units</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;delr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span> <span class="o">*</span> <span class="n">lmult</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;delc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span> <span class="o">*</span> <span class="n">lmult</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">array</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;botm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">botm</span><span class="o">.</span><span class="n">array</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="p">,</span> <span class="s1">&#39;laycbd&#39;</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;laycbd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">laycbd</span><span class="o">.</span><span class="n">array</span>
        <span class="c1"># renames for parent modelgrid</span>
        <span class="n">renames</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rotation&#39;</span><span class="p">:</span> <span class="s1">&#39;angrot&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">renames</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">MFsetupGrid</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_mg_resync</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_modelgrid</span> <span class="o">=</span> <span class="n">MFsetupGrid</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set attributes related to a parent or source model</span>
<span class="sd">        if one is specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if it&#39;s an LGR model (where parent is also being created)</span>
        <span class="c1"># set up the parent DIS package</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_lgr</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">MFsetupMixin</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;DIS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_package_list</span><span class="p">():</span>
                <span class="n">dis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setup_dis</span><span class="p">()</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># load MF6 or MF2005 parent</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading parent model </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;model_ws&#39;</span><span class="p">],</span>
                                                                 <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;namefile&#39;</span><span class="p">])))</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># load only specified packages that the parent model has</span>
                <span class="n">packages_in_parent_namefile</span> <span class="o">=</span> <span class="n">get_packages</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;model_ws&#39;</span><span class="p">],</span>
                                                                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;namefile&#39;</span><span class="p">]))</span>
                <span class="n">specified_packages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;packages&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">()))</span>

                <span class="c1"># get equivalent packages to load if parent is another MODFLOW version;</span>
                <span class="c1"># then flatten (a package may have more than one equivalent)</span>
                <span class="n">parent_packages</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_package_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">])</span>
                                   <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">specified_packages</span><span class="p">]</span>
                <span class="n">parent_packages</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span> <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">parent_packages</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">subset</span><span class="p">}</span>
                <span class="n">load_only</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">packages_in_parent_namefile</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">parent_packages</span><span class="p">))</span>
                <span class="k">if</span> <span class="s1">&#39;load_only&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;load_only&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_only</span>
                <span class="k">if</span> <span class="s1">&#39;skip_load&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;skip_load&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;skip_load&#39;</span><span class="p">]]</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;load_only&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pckg</span> <span class="k">for</span> <span class="n">pckg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;load_only&#39;</span><span class="p">]</span>
                                           <span class="k">if</span> <span class="n">pckg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;skip_load&#39;</span><span class="p">]]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                    <span class="n">sim_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;sim_name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                        <span class="n">sim_kwargs</span><span class="p">[</span><span class="s1">&#39;sim_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">,</span> <span class="s1">&#39;mfsim&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;sim_ws&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                        <span class="n">sim_kwargs</span><span class="p">[</span><span class="s1">&#39;sim_ws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_ws&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="n">sim_kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">sim_kwargs</span><span class="p">,</span> <span class="n">mf6</span><span class="o">.</span><span class="n">MFSimulation</span><span class="o">.</span><span class="n">load</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">parent_sim</span> <span class="o">=</span> <span class="n">mf6</span><span class="o">.</span><span class="n">MFSimulation</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="o">**</span><span class="n">sim_kwargs</span><span class="p">)</span>
                    <span class="n">modelname</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;namefile&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent_sim</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">modelname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;namefile&#39;</span><span class="p">)</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">fm</span><span class="o">.</span><span class="n">Modflow</span><span class="o">.</span><span class="n">load</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">Modflow</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finished in </span><span class="si">{:.2f}</span><span class="s2">s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

            <span class="c1"># set parent model units in config if not entered</span>
            <span class="k">if</span> <span class="s1">&#39;length_units&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">][</span><span class="s1">&#39;length_units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_model_length_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;time_units&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">][</span><span class="s1">&#39;time_units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_model_time_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

            <span class="c1"># set the parent model grid from mg_kwargs if not None</span>
            <span class="c1"># otherwise, convert parent model grid to MFsetupGrid</span>
            <span class="n">mg_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SpatialReference&#39;</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modelgrid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent_modelgrid</span><span class="p">(</span><span class="n">mg_kwargs</span><span class="p">)</span>

            <span class="c1"># setup parent model perioddata table</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;perioddata&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;model_time_units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">][</span><span class="s1">&#39;time_units&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;perlen&#39;</span><span class="p">,</span> <span class="s1">&#39;nstp&#39;</span><span class="p">,</span> <span class="s1">&#39;tsmult&#39;</span><span class="p">]:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modeltime</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;steady&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modeltime</span><span class="o">.</span><span class="n">steady_state</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;nper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">tdis</span><span class="o">.</span><span class="n">nper</span><span class="o">.</span><span class="n">array</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;perlen&#39;</span><span class="p">,</span> <span class="s1">&#39;steady&#39;</span><span class="p">,</span> <span class="s1">&#39;nstp&#39;</span><span class="p">,</span> <span class="s1">&#39;tsmult&#39;</span><span class="p">]:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">array</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;nper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">nper</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">setup_perioddata_group</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oc_saverecord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;_perioddata&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_perioddata</span> <span class="o">=</span> <span class="n">setup_perioddata_group</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">perioddata</span> <span class="o">=</span> <span class="n">setup_perioddata_group</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># default_source_data, where omitted configuration input is</span>
            <span class="c1"># obtained from parent model by default</span>
            <span class="c1"># Set default_source_data to True by default if it isn&#39;t specified</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_source_data&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">][</span><span class="s1">&#39;default_source_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_source_data&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parent_default_source_data</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># set number of layers from parent if not specified</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nlay&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;dimensions&#39;</span><span class="p">][</span><span class="s1">&#39;nlay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">nlay</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nlay&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;nlay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">nlay</span>

                <span class="c1"># set start date/time from parent if not specified</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_lgr</span><span class="p">:</span>
                    <span class="n">parent_start_date_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_date_time&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;tdis&#39;</span><span class="p">][</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_date_time&#39;</span><span class="p">,</span> <span class="s1">&#39;1970-01-01&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1970-01-01&#39;</span> \
                                <span class="ow">and</span> <span class="n">parent_start_date_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;tdis&#39;</span><span class="p">][</span><span class="s1">&#39;options&#39;</span><span class="p">][</span><span class="s1">&#39;start_date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">][</span><span class="s1">&#39;start_date_time&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_date_time&#39;</span><span class="p">,</span> <span class="s1">&#39;1970-01-01&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1970-01-01&#39;</span> \
                                <span class="ow">and</span> <span class="n">parent_start_date_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;start_date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">][</span><span class="s1">&#39;start_date_time&#39;</span><span class="p">]</span>

                    <span class="c1"># only get time dis information from parent if</span>
                    <span class="c1"># no periodata groups are specified, and nper is not specified under dimensions</span>
                    <span class="n">tdis_package</span> <span class="o">=</span> <span class="s1">&#39;tdis&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span> <span class="k">else</span> <span class="s1">&#39;dis&#39;</span>
                    <span class="c1"># check if any item within perioddata block is a dictionary</span>
                    <span class="c1"># (groups are subblocks within perioddata block)</span>
                    <span class="n">has_perioddata_groups</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                                                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">tdis_package</span><span class="p">][</span><span class="s1">&#39;perioddata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
                    <span class="c1"># get the number of inset model periods</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_perioddata_groups</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;tdis&#39;</span><span class="p">][</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nper&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;tdis&#39;</span><span class="p">][</span><span class="s1">&#39;dimensions&#39;</span><span class="p">][</span><span class="s1">&#39;nper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modeltime</span><span class="o">.</span><span class="n">nper</span>
                            <span class="n">nper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;tdis&#39;</span><span class="p">][</span><span class="s1">&#39;dimensions&#39;</span><span class="p">][</span><span class="s1">&#39;nper&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;nper&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;nper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">nper</span>
                            <span class="n">nper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;nper&#39;</span><span class="p">]</span>
                        <span class="c1"># get the periods that are shared with the parent model</span>
                        <span class="n">parent_periods</span> <span class="o">=</span> <span class="n">get_parent_stress_periods</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nper</span><span class="o">=</span><span class="n">nper</span><span class="p">,</span>
                                                                   <span class="n">parent_stress_periods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">][</span>
                                                                       <span class="s1">&#39;copy_stress_periods&#39;</span><span class="p">])</span>
                        <span class="c1"># get time discretization info. from the parent model</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;perlen&#39;</span><span class="p">,</span> <span class="s1">&#39;nstp&#39;</span><span class="p">,</span> <span class="s1">&#39;tsmult&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;tdis&#39;</span><span class="p">][</span><span class="s1">&#39;perioddata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;tdis&#39;</span><span class="p">][</span><span class="s1">&#39;perioddata&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modeltime</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span>
                                        <span class="n">parent_periods</span><span class="p">]</span>
                                <span class="c1"># &#39;steady&#39; can be specified under sto package (as in MODFLOW-6)</span>
                                <span class="c1"># or within perioddata group blocks</span>
                                <span class="c1"># but not in the tdis perioddata block itset</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sto&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;steady&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sto&#39;</span><span class="p">][</span><span class="s1">&#39;steady&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">modeltime</span><span class="o">.</span><span class="n">steady_state</span><span class="p">[</span><span class="n">parent_periods</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;perlen&#39;</span><span class="p">,</span> <span class="s1">&#39;nstp&#39;</span><span class="p">,</span> <span class="s1">&#39;tsmult&#39;</span><span class="p">,</span> <span class="s1">&#39;steady&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">parent_periods</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_setup_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">1e30</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1e30</span><span class="p">,</span>
                      <span class="n">source_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source_package</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">setup_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                           <span class="n">source_model</span><span class="o">=</span><span class="n">source_model</span><span class="p">,</span> <span class="n">source_package</span><span class="o">=</span><span class="n">source_package</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_basic_stress_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">flopy_package_class</span><span class="p">,</span>
                                    <span class="n">variable_columns</span><span class="p">,</span> <span class="n">rivdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Setting up </span><span class="si">{</span><span class="n">package</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1"> package...&#39;</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># possible future support to</span>
        <span class="c1"># handle filenames of multiple packages</span>
        <span class="c1"># leave this out for now because of additional complexity</span>
        <span class="c1"># from multiple sets of external files</span>
        <span class="c1">#existing_packages = getattr(self, package, None)</span>
        <span class="c1">#filename = f&quot;{self.name}.{package}&quot;</span>
        <span class="c1">#if existing_packages is not None:</span>
        <span class="c1">#    try:</span>
        <span class="c1">#        len(existing_packages)</span>
        <span class="c1">#        suffix = len(existing_packages) + 1</span>
        <span class="c1">#    except:</span>
        <span class="c1">#        suffix = 1</span>
        <span class="c1">#    filename = f&quot;{self.name}-{suffix}.{package}&quot;</span>

        <span class="c1"># perimeter boundary (CHD or WEL)</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;perimeter_boundary&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">perimeter_cfg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;perimeter_boundary&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">package</span> <span class="o">==</span> <span class="s1">&#39;chd&#39;</span><span class="p">:</span>
                <span class="n">perimeter_cfg</span><span class="p">[</span><span class="s1">&#39;boundary_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;head&#39;</span>
                <span class="n">boundname</span> <span class="o">=</span> <span class="s1">&#39;perimeter-heads&#39;</span>
            <span class="k">elif</span> <span class="n">package</span> <span class="o">==</span> <span class="s1">&#39;wel&#39;</span><span class="p">:</span>
                <span class="n">perimeter_cfg</span><span class="p">[</span><span class="s1">&#39;boundary_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flux&#39;</span>
                <span class="n">boundname</span> <span class="o">=</span> <span class="s1">&#39;perimeter-fluxes&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported package for perimeter_boundary: </span><span class="si">{</span><span class="n">package</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;inset_parent_period_mapping&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">perimeter_cfg</span><span class="p">:</span>
                <span class="n">perimeter_cfg</span><span class="p">[</span><span class="s1">&#39;inset_parent_period_mapping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_stress_periods</span>
            <span class="k">if</span> <span class="s1">&#39;parent_start_time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">perimeter_cfg</span><span class="p">:</span>
                <span class="n">perimeter_cfg</span><span class="p">[</span><span class="s1">&#39;parent_start_date_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmr</span> <span class="o">=</span> <span class="n">Tmr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">perimeter_cfg</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmr</span><span class="o">.</span><span class="n">get_inset_boundary_values</span><span class="p">()</span>

            <span class="c1"># add boundname to allow boundary flux to be tracked as observation</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;boundname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boundname</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># RIV package converted from SFR input</span>
        <span class="k">elif</span> <span class="n">rivdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">rivdata</span><span class="o">.</span><span class="n">stress_period_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">rivdata</span><span class="o">.</span><span class="n">stress_period_data</span><span class="p">[</span><span class="s1">&#39;boundname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rivdata</span><span class="o">.</span><span class="n">stress_period_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rivdata</span><span class="o">.</span><span class="n">stress_period_data</span><span class="p">)</span>

        <span class="c1"># set up package from user input</span>
        <span class="n">df_sd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;source_data&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">package</span> <span class="o">==</span> <span class="s1">&#39;wel&#39;</span><span class="p">:</span>
                <span class="n">dropped_wells_file</span> <span class="o">=</span>\
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;output_files&#39;</span><span class="p">][</span><span class="s1">&#39;dropped_wells_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">df_sd</span> <span class="o">=</span> <span class="n">setup_wel_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                       <span class="n">source_data</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;source_data&#39;</span><span class="p">],</span>
                                       <span class="n">dropped_wells_file</span><span class="o">=</span><span class="n">dropped_wells_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_sd</span> <span class="o">=</span> <span class="n">setup_basic_stress_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;source_data&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mfsetup_options&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">df_sd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_sd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_sd</span><span class="p">)</span>
        <span class="c1"># set up package from parent model</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_source_data&#39;</span><span class="p">)</span> <span class="ow">and</span>\
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">package</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">package</span> <span class="o">==</span> <span class="s1">&#39;wel&#39;</span><span class="p">:</span>
                <span class="n">dropped_wells_file</span> <span class="o">=</span>\
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;output_files&#39;</span><span class="p">][</span><span class="s1">&#39;dropped_wells_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">df_sd</span> <span class="o">=</span> <span class="n">setup_wel_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                       <span class="n">dropped_wells_file</span><span class="o">=</span><span class="n">dropped_wells_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skipping setup of </span><span class="si">{</span><span class="n">package</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1"> Package from parent model-- not implemented.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df_sd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_sd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_sd</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">package</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> package:</span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="s2">&quot;No input specified or package configuration file input &quot;</span>
                  <span class="s2">&quot;not understood. See the Configuration &quot;</span>
                  <span class="s2">&quot;File Gallery in the online docs for example input &quot;</span>
                  <span class="s2">&quot;Note that direct input to basic stress period packages &quot;</span>
                  <span class="s2">&quot;is currently not supported.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># option to write stress_period_data to external files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
            <span class="n">external_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">package</span><span class="p">][</span><span class="s1">&#39;mfsetup_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;external_files&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># external list or tabular type files not supported for MODFLOW-NWT</span>
            <span class="c1"># adding support for this may require changes to Flopy</span>
            <span class="n">external_files</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">external_filename_fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">package</span><span class="p">][</span><span class="s1">&#39;mfsetup_options&#39;</span><span class="p">][</span><span class="s1">&#39;external_filename_fmt&#39;</span><span class="p">]</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="n">setup_flopy_stress_period_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span>
                                                 <span class="n">flopy_package_class</span><span class="o">=</span><span class="n">flopy_package_class</span><span class="p">,</span>
                                                 <span class="n">variable_columns</span><span class="o">=</span><span class="n">variable_columns</span><span class="p">,</span>
                                                 <span class="n">external_files</span><span class="o">=</span><span class="n">external_files</span><span class="p">,</span>
                                                 <span class="n">external_filename_fmt</span><span class="o">=</span><span class="n">external_filename_fmt</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">package</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">package</span><span class="p">][</span><span class="s1">&#39;options&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">package</span><span class="p">][</span><span class="s1">&#39;options&#39;</span><span class="p">])</span>
        <span class="c1">#kwargs[&#39;filename&#39;] = filename</span>
        <span class="c1"># add observation for perimeter BCs</span>
        <span class="c1"># and any user input with a boundname col</span>
        <span class="n">obslist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">obsfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s1">.obs.output.csv&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;perimeter_boundary&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">perimeter_btype</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;perimeter-</span><span class="si">{</span><span class="n">perimeter_cfg</span><span class="p">[</span><span class="s1">&#39;boundary_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">obslist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">perimeter_btype</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">perimeter_btype</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;boundname&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">unique_boundnames</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;boundname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">bname</span> <span class="ow">in</span> <span class="n">unique_boundnames</span><span class="p">:</span>
                <span class="n">obslist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bname</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">bname</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;observations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">obsfile</span><span class="p">:</span> <span class="n">obslist</span><span class="p">}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">flopy_package_class</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">external_files</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;stress_period_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spd</span>
        <span class="n">pckg</span> <span class="o">=</span> <span class="n">flopy_package_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finished in </span><span class="si">{:.2f}</span><span class="s2">s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pckg</span>

<div class="viewcode-block" id="MFsetupMixin.setup_grid">
<a class="viewcode-back" href="../../api/mfsetup.mfmodel.html#mfsetup.mfmodel.MFsetupMixin.setup_grid">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the attached modelgrid instance from configuration input</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;setup_grid&#39;</span><span class="p">]</span> <span class="c1">#.copy()</span>
        <span class="c1"># update grid configuration with any information supplied to dis package</span>
        <span class="c1"># (so that settings specified for DIS package have priority)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_grid_configuration_with_dis</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;structured&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Support for unstructured grids&#39;</span><span class="p">)</span>
        <span class="n">features_shapefile</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;features_shapefile&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">features_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;features_shapefile&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">features_shapefile</span><span class="p">[</span><span class="s1">&#39;features_shapefile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features_shapefile</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">features_shapefile</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">features_shapefile</span><span class="p">)</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;parent_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;model_length_units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length_units</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;output_files&#39;</span><span class="p">][</span><span class="s1">&#39;grid_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">bbox_shapefile_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;output_files&#39;</span><span class="p">][</span><span class="s1">&#39;bbox_shapefile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">name</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;bbox_shapefile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shapefiles_path</span><span class="p">)</span> <span class="o">/</span> <span class="n">bbox_shapefile_name</span>
        <span class="k">if</span> <span class="s1">&#39;DIS&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_package_list</span><span class="p">():</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">array</span>
            <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;botm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">botm</span><span class="o">.</span><span class="n">array</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid_file&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading model grid definition from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid_file&#39;</span><span class="p">]))</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">load</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid_file&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">],</span> <span class="n">MFsetupGrid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modelgrid</span> <span class="o">=</span> <span class="n">MFsetupGrid</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modelgrid</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">setup_structured_grid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modelgrid</span> <span class="o">=</span> <span class="n">setup_structured_grid</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelgrid</span><span class="o">.</span><span class="n">cfg</span>
            <span class="c1"># update DIS package configuration</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;dimensions&#39;</span><span class="p">][</span><span class="s1">&#39;nrow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;nrow&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;dimensions&#39;</span><span class="p">][</span><span class="s1">&#39;ncol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;ncol&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;nrow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;nrow&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;ncol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;ncol&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_bc_arrays</span><span class="p">()</span>

        <span class="c1"># set up local grid refinement</span>
        <span class="k">if</span> <span class="s1">&#39;lgr&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;setup_grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;LGR only supported for MODFLOW-6 models.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lgr</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;setup_grid&#39;</span><span class="p">][</span><span class="s1">&#39;lgr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">config_file</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
                <span class="n">existing_inset_config_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inset</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">existing_inset_config_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inset</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">if</span> <span class="n">config_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_inset_config_files</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_lgr_models</span><span class="p">()</span></div>


<div class="viewcode-block" id="MFsetupMixin.load_grid">
<a class="viewcode-back" href="../../api/mfsetup.mfmodel.html#mfsetup.mfmodel.MFsetupMixin.load_grid">[docs]</a>
    <span class="k">def</span> <span class="nf">load_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load model grid information from a json or yml file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">gridfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;setup_grid&#39;</span><span class="p">][</span><span class="s1">&#39;grid_file&#39;</span><span class="p">]):</span>
                <span class="n">gridfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;setup_grid&#39;</span><span class="p">][</span><span class="s1">&#39;grid_file&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading model grid information from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gridfile</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">gridfile</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">setup_sfr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">package</span> <span class="o">=</span> <span class="s1">&#39;sfr&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Setting up </span><span class="si">{}</span><span class="s1"> package...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># input</span>
        <span class="n">flowlines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flowlines&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flowlines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;nhdplus_paths&#39;</span> <span class="ow">in</span> <span class="n">flowlines</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">nhdplus_paths</span> <span class="o">=</span> <span class="n">flowlines</span><span class="p">[</span><span class="s1">&#39;nhdplus_paths&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">nhdplus_paths</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SFR setup: missing input file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                        <span class="n">nhdplus_paths</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nhdplus_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="c1"># create an sfrmaker.lines instance</span>
                <span class="n">bbox_filter</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="s1">&#39;epsg:4269&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="o">.</span><span class="n">from_nhdplus_v2</span><span class="p">(</span><span class="n">NHDPlus_paths</span><span class="o">=</span><span class="n">nhdplus_paths</span><span class="p">,</span>
                                            <span class="n">bbox_filter</span><span class="o">=</span><span class="n">bbox_filter</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;filenames&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">flowlines</span><span class="p">:</span>
                        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">flowlines</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;shapefile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">check_source_files</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;shapefile&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39;epsg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="kn">from</span> <span class="nn">gisutils</span> <span class="kn">import</span> <span class="n">get_shapefile_crs</span>
                                <span class="n">shapefile_crs</span> <span class="o">=</span> <span class="n">get_shapefile_crs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;shapefile&#39;</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Need gis-utils &gt;= 0.2 to get crs&#39;</span>
                                       <span class="s1">&#39; for shapefile: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">Please pip install &#39;</span>
                                       <span class="s1">&#39;--upgrade gis-utils&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;shapefile&#39;</span><span class="p">]))</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">shapefile_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;epsg&#39;</span><span class="p">])</span>
                        <span class="n">authority</span> <span class="o">=</span> <span class="n">shapefile_crs</span><span class="o">.</span><span class="n">to_authority</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">authority</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">shapefile_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_user_input</span><span class="p">(</span><span class="n">shapefile_crs</span><span class="o">.</span><span class="n">to_authority</span><span class="p">())</span>

                        <span class="n">bbox_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>
                        <span class="k">if</span> <span class="n">shapefile_crs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                            <span class="n">bbox_filter</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">shapefile_crs</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;bbox_filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bbox_filter</span>
                        <span class="c1"># create an sfrmaker.lines instance</span>
                        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">Lines</span><span class="o">.</span><span class="n">from_shapefile</span><span class="p">)</span>
                        <span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="o">.</span><span class="n">from_shapefile</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># output</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;postprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;output_folders&#39;</span><span class="p">][</span><span class="s1">&#39;shapefiles&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">][</span><span class="s1">&#39;output_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_path</span>

        <span class="c1"># create isfr array (where SFR cells will be populated)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
            <span class="n">active_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idomain</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="c1">#active_cells = self.idomain.sum(axis=0) &gt; 0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">active_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ibound</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="c1">#active_cells = self.ibound.sum(axis=0) &gt; 0</span>
        <span class="c1"># only include active cells that don&#39;t have another boundary condition</span>
        <span class="c1"># (besides the wel package)</span>
        <span class="n">isfr</span> <span class="o">=</span> <span class="n">active_cells</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isbc2d</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1">#  kludge to get sfrmaker to work with modelgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="o">.</span><span class="n">model_length_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length_units</span>

        <span class="c1"># create an sfrmaker.sfrdata instance from the lines instance</span>
        <span class="n">to_sfr_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sfrmaker_options&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">][</span><span class="s1">&#39;sfrmaker_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">to_sfr_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">][</span><span class="s1">&#39;sfrmaker_options&#39;</span><span class="p">])</span>
        <span class="c1">#to_sfr_kwargs = get_input_arguments(to_sfr_kwargs, Lines.to_sfr)</span>
        <span class="n">sfr</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">to_sfr</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modelgrid</span><span class="p">,</span>
                         <span class="n">isfr</span><span class="o">=</span><span class="n">isfr</span><span class="p">,</span>
                         <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">to_sfr_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;set_streambed_top_elevations_from_dem&#39;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;sfr: set_streambed_top_elevations_from_dem option is now under sfr: sfrmaker_options&#39;</span><span class="p">,</span>
                          <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">][</span><span class="s1">&#39;sfrmaker_options&#39;</span><span class="p">][</span><span class="s1">&#39;set_streambed_top_elevations_from_dem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">][</span><span class="s1">&#39;sfrmaker_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;set_streambed_top_elevations_from_dem&#39;</span><span class="p">):</span>
            <span class="n">dem_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">][</span><span class="s1">&#39;sfrmaker_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;set_streambed_top_elevations_from_dem&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dem_kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">dem_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;If set_streambed_top_elevations_from_dem=True, &quot;</span>
                    <span class="s2">&quot;need a dem block in source_data for SFR package. &quot;</span>
                    <span class="s2">&quot;Otherwise set_streambed_top_elevations_from_dem should be&quot;</span>
                    <span class="s2">&quot;a block with arguments to &quot;</span>
                    <span class="s2">&quot;sfrmaker.SFRData.set_streambed_top_elevations_from_dem&quot;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="s1">&#39;dem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">error_msg</span>
                <span class="n">dem_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">][</span><span class="s1">&#39;source_data&#39;</span><span class="p">][</span><span class="s1">&#39;dem&#39;</span><span class="p">])</span>
            <span class="n">sfr</span><span class="o">.</span><span class="n">set_streambed_top_elevations_from_dem</span><span class="p">(</span><span class="o">**</span><span class="n">dem_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sfr</span><span class="o">.</span><span class="n">reach_data</span><span class="p">[</span><span class="s1">&#39;strtop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfr</span><span class="o">.</span><span class="n">interpolate_to_reaches</span><span class="p">(</span><span class="s1">&#39;elevup&#39;</span><span class="p">,</span> <span class="s1">&#39;elevdn&#39;</span><span class="p">)</span>

        <span class="c1"># assign layers to the sfr reaches</span>
        <span class="n">botm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">botm</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
            <span class="n">idomain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">idomain</span><span class="o">.</span><span class="n">array</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idomain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="o">.</span><span class="n">array</span>
        <span class="n">layers</span><span class="p">,</span> <span class="n">new_botm</span> <span class="o">=</span> <span class="n">assign_layers</span><span class="p">(</span><span class="n">sfr</span><span class="o">.</span><span class="n">reach_data</span><span class="p">,</span>
                                         <span class="n">botm_array</span><span class="o">=</span><span class="n">botm</span><span class="p">,</span>
                                         <span class="n">idomain</span><span class="o">=</span><span class="n">idomain</span><span class="p">)</span>
        <span class="n">sfr</span><span class="o">.</span><span class="n">reach_data</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layers</span>
        <span class="k">if</span> <span class="n">new_botm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;intermediate_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;botm&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">external_path</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;botm_filename_fmt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                  <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;intermediate_data&#39;</span><span class="p">][</span><span class="s1">&#39;botm&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">save_array</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">new_botm</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(new model botm after assigning SFR reaches to layers)&#39;</span><span class="p">)</span>
            <span class="n">botm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_botm</span>
            <span class="c1"># run thru setup_array so that DIS input remains open/close</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_array</span><span class="p">(</span><span class="s1">&#39;dis&#39;</span><span class="p">,</span> <span class="s1">&#39;botm&#39;</span><span class="p">,</span>
                              <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">arr</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">botm</span><span class="p">)},</span>
                              <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;array3d&#39;</span><span class="p">,</span> <span class="n">write_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="c1"># reset the bottom array</span>
            <span class="c1"># is this necessary?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">botm</span> <span class="o">=</span> <span class="n">botm</span>
            <span class="c1"># set bottom array to external files</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">botm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;griddata&#39;</span><span class="p">][</span><span class="s1">&#39;botm&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">botm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;dis&#39;</span><span class="p">][</span><span class="s1">&#39;botm&#39;</span><span class="p">]</span>

        <span class="c1"># option to convert reaches to the River Package</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to_riv&#39;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;sfr: to_riv option is now under sfr: sfrmaker_options&#39;</span><span class="p">,</span>
                          <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">][</span><span class="s1">&#39;sfrmaker_options&#39;</span><span class="p">][</span><span class="s1">&#39;to_riv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to_riv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sfrmaker_options&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to_riv&#39;</span><span class="p">):</span>
            <span class="n">rivdata</span> <span class="o">=</span> <span class="n">sfr</span><span class="o">.</span><span class="n">to_riv</span><span class="p">(</span><span class="n">line_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">][</span><span class="s1">&#39;sfrmaker_options&#39;</span><span class="p">][</span><span class="s1">&#39;to_riv&#39;</span><span class="p">],</span>
                                 <span class="n">drop_in_sfr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># setup of RIV package from SFRmaker-derived RIVdata</span>
            <span class="c1"># and any user input</span>
            <span class="c1"># do this instead of 2 seperate packages</span>
            <span class="c1"># to avoid having two sets of external files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_riv</span><span class="p">(</span><span class="n">rivdata</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;riv&#39;</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;riv&#39;</span><span class="p">][</span><span class="s1">&#39;mfsetup_options&#39;</span><span class="p">])</span>
            <span class="n">rivdata_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;riv&#39;</span><span class="p">][</span><span class="s1">&#39;output_files&#39;</span><span class="p">][</span><span class="s1">&#39;rivdata_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">rivdata</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tables_path</span><span class="p">,</span> <span class="n">rivdata_filename</span><span class="p">))</span>
            <span class="n">rivdata</span><span class="o">.</span><span class="n">write_shapefiles</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shapefiles_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c1"># optional routing input</span>
        <span class="c1"># (for a complete representation of a larger or more detailed</span>
        <span class="c1">#  stream network that may be culled in SFR package)</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">routing_input_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sd</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;routing&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">routing_input</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">routing_input_key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">routing_input</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">routing_input_key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">routing</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">routing_input</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
            <span class="n">routing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">routing</span><span class="p">[</span><span class="n">routing_input</span><span class="p">[</span><span class="s1">&#39;id_column&#39;</span><span class="p">]],</span>
                               <span class="n">routing</span><span class="p">[</span><span class="n">routing_input</span><span class="p">[</span><span class="s1">&#39;routing_column&#39;</span><span class="p">]]))</span>
            <span class="c1"># set any values (downstream lines) not in keys (upstream lines)</span>
            <span class="c1"># to 0 (outlet condition)</span>
            <span class="n">routing</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">routing</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
                       <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">routing</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="c1"># use _original_routing attached to Lines instance as default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">routing</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">_original_routing</span>

        <span class="c1"># add inflows</span>
        <span class="n">inflows_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inflows&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inflows_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># resample inflows to model stress periods</span>
            <span class="n">inflows_input</span><span class="p">[</span><span class="s1">&#39;id_column&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inflows_input</span><span class="p">[</span><span class="s1">&#39;line_id_column&#39;</span><span class="p">]</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="n">TransientTabularSourceData</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">inflows_input</span><span class="p">,</span>
                                                        <span class="n">dest_model</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">inflows_by_stress_period</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

            <span class="c1"># check if all inflow sites are included in sfr network</span>
            <span class="n">missing_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inflows_by_stress_period</span><span class="p">[</span><span class="n">inflows_input</span><span class="p">[</span><span class="s1">&#39;id_column&#39;</span><span class="p">]])</span><span class="o">.</span> \
                                <span class="n">difference</span><span class="p">(</span><span class="n">routing</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="c1"># if there are missing sites, try using the supplied routing</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">missing_sites</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">((</span><span class="s1">&#39;inflow sites </span><span class="si">{}</span><span class="s1"> are not within the model sfr network. &#39;</span>
                                <span class="s1">&#39;Please supply an inflows_routing source_data block &#39;</span>
                                <span class="s1">&#39;(see shellmound example config file)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">missing_sites</span><span class="p">)))</span>

            <span class="c1"># add resampled inflows to SFR package</span>
            <span class="n">inflows_input</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inflows_by_stress_period</span>
            <span class="n">inflows_input</span><span class="p">[</span><span class="s1">&#39;flowline_routing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">routing</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                <span class="n">inflows_input</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;inflow&#39;</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">sfr</span><span class="o">.</span><span class="n">add_to_perioddata</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inflows_input</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flow&#39;</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">sfr</span><span class="o">.</span><span class="n">add_to_segment_data</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">inflows_input</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">method</span><span class="p">)</span>
            <span class="n">method</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># add runoff</span>
        <span class="n">runoff_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runoff&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">runoff_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># resample inflows to model stress periods</span>
            <span class="n">runoff_input</span><span class="p">[</span><span class="s1">&#39;id_column&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runoff_input</span><span class="p">[</span><span class="s1">&#39;line_id_column&#39;</span><span class="p">]</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="n">TransientTabularSourceData</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">runoff_input</span><span class="p">,</span>
                                                        <span class="n">dest_model</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">runoff_by_stress_period</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

            <span class="c1"># check if all sites are included in sfr network</span>
            <span class="n">missing_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">runoff_by_stress_period</span><span class="p">[</span><span class="n">runoff_input</span><span class="p">[</span><span class="s1">&#39;id_column&#39;</span><span class="p">]])</span><span class="o">.</span> \
                                <span class="n">difference</span><span class="p">(</span><span class="n">routing</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">missing_sites</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span><span class="s1">&#39;runoff sites </span><span class="si">{}</span><span class="s1"> are not within the model sfr network. &#39;</span>
                               <span class="s1">&#39;Please supply an inflows_routing source_data block &#39;</span>
                               <span class="s1">&#39;(see shellmound example config file)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">missing_sites</span><span class="p">)),</span>
                               <span class="ne">UserWarning</span><span class="p">)</span>

            <span class="c1"># add resampled inflows to SFR package</span>
            <span class="n">runoff_input</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runoff_by_stress_period</span>
            <span class="n">runoff_input</span><span class="p">[</span><span class="s1">&#39;flowline_routing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">routing</span>
            <span class="n">runoff_input</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;runoff&#39;</span>
            <span class="n">runoff_input</span><span class="p">[</span><span class="s1">&#39;distribute_flows_to_reaches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">sfr</span><span class="o">.</span><span class="n">add_to_perioddata</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">sfr</span><span class="o">.</span><span class="n">add_to_segment_data</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">runoff_input</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">method</span><span class="p">)</span>
            <span class="n">method</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># add observations</span>
        <span class="n">observations_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sfr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;observations&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
            <span class="n">sfr</span><span class="o">.</span><span class="n">gage_starting_unit_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;gag&#39;</span><span class="p">][</span><span class="s1">&#39;starting_unit_number&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">observations_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;filename&#39;</span> <span class="k">if</span> <span class="s1">&#39;filename&#39;</span> <span class="ow">in</span> <span class="n">observations_input</span> <span class="k">else</span> <span class="s1">&#39;filenames&#39;</span>
            <span class="n">observations_input</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observations_input</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">observations_input</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">sfr</span><span class="o">.</span><span class="n">add_observations</span><span class="p">)</span>
            <span class="n">obsdata</span> <span class="o">=</span> <span class="n">sfr</span><span class="o">.</span><span class="n">add_observations</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">2</span>
            <span class="c1"># resample observations to model stress periods; write to table</span>

        <span class="c1"># write reach and segment data tables</span>
        <span class="n">sfr</span><span class="o">.</span><span class="n">write_tables</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tables_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c1"># export shapefiles of lines, routing, cell polygons, inlets and outlets</span>
        <span class="n">sfr</span><span class="o">.</span><span class="n">write_shapefiles</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shapefiles_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c1"># create the flopy SFR package instance</span>
        <span class="n">sfr</span><span class="o">.</span><span class="n">create_modflow_sfr2</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">istcb2</span><span class="o">=</span><span class="mi">223</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
            <span class="n">sfr_package</span> <span class="o">=</span> <span class="n">sfr</span><span class="o">.</span><span class="n">modflow_sfr2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># pass options kwargs through to mf6 constructor</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">package</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span>
                              <span class="p">{</span><span class="s1">&#39;source_data&#39;</span><span class="p">,</span> <span class="s1">&#39;flowlines&#39;</span><span class="p">,</span> <span class="s1">&#39;inflows&#39;</span><span class="p">,</span> <span class="s1">&#39;observations&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;inflows_routing&#39;</span><span class="p">,</span> <span class="s1">&#39;dem&#39;</span><span class="p">,</span> <span class="s1">&#39;sfrmaker_options&#39;</span><span class="p">}})</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">get_input_arguments</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">mf6</span><span class="o">.</span><span class="n">ModflowGwfsfr</span><span class="p">)</span>
            <span class="n">sfr_package</span> <span class="o">=</span> <span class="n">sfr</span><span class="o">.</span><span class="n">create_mf6sfr</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># monkey patch ModflowGwfsfr instance to behave like ModflowSfr2</span>
            <span class="n">sfr_package</span><span class="o">.</span><span class="n">reach_data</span> <span class="o">=</span> <span class="n">sfr</span><span class="o">.</span><span class="n">modflow_sfr2</span><span class="o">.</span><span class="n">reach_data</span>

        <span class="c1"># attach the sfrmaker.sfrdata instance as an attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfrdata</span> <span class="o">=</span> <span class="n">sfr</span>

        <span class="c1"># reset dependent arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_bc_arrays</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_idomain</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finished in </span><span class="si">{:.2f}</span><span class="s2">s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">sfr_package</span>

    <span class="k">def</span> <span class="nf">setup_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;mf6&#39;</span><span class="p">:</span>
            <span class="n">solver_package</span> <span class="o">=</span> <span class="s1">&#39;ims&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solver_package</span> <span class="o">=</span> <span class="s1">&#39;nwt&#39;</span>
        <span class="k">assert</span> <span class="n">solver_package</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_list</span>
        <span class="n">setup_method_name</span> <span class="o">=</span> <span class="s1">&#39;setup_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver_package</span><span class="p">)</span>
        <span class="n">package_setup</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_method_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">package_setup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setup_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">package_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_list</span> <span class="c1">#[&#39;sfr&#39;] #m.package_list # [&#39;tdis&#39;, &#39;dis&#39;, &#39;npf&#39;, &#39;oc&#39;]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reset_existing</span><span class="p">:</span>
            <span class="n">package_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">package_list</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_package_list</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">package_list</span><span class="p">:</span>
            <span class="n">setup_method_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;setup_</span><span class="si">{</span><span class="n">pkg</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">package_setup</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_method_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">package_setup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> package not supported for MODFLOW version=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">package_setup</span><span class="p">):</span>
                <span class="n">package_setup</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">MFsetupMixin</span><span class="p">,</span> <span class="s1">&#39;setup_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;6&#39;</span><span class="p">)))</span>
            <span class="c1"># avoid multiple package instances for now, except for obs</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="s1">&#39;mf6&#39;</span> <span class="ow">or</span> <span class="n">pkg</span> <span class="o">==</span> <span class="s1">&#39;obs&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
                <span class="n">package_setup</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">pkg</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">pkg</span><span class="p">][</span><span class="s1">&#39;mfsetup_options&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="MFsetupMixin.load_cfg">
<a class="viewcode-back" href="../../api/mfsetup.mfmodel.html#mfsetup.mfmodel.MFsetupMixin.load_cfg">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_cfg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">yamlfile</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads a configuration file, with default settings</span>
<span class="sd">        specific to the MFnwtModel or MF6model class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        yamlfile : str (filepath)</span>
<span class="sd">            Configuration file in YAML format with pfl_nwt setup information.</span>
<span class="sd">        verbose : bool</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cfg : dict (configuration dictionary)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">load_cfg</span><span class="p">(</span><span class="n">yamlfile</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">default_file</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">default_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="MFsetupMixin.setup_from_yaml">
<a class="viewcode-back" href="../../api/mfsetup.mfmodel.html#mfsetup.mfmodel.MFsetupMixin.setup_from_yaml">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setup_from_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">yamlfile</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a model from scratch, using information in a yamlfile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        yamlfile : str (filepath)</span>
<span class="sd">            Configuration file in YAML format with pfl_nwt setup information.</span>
<span class="sd">        verbose : bool</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        m : model instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load_cfg</span><span class="p">(</span><span class="n">yamlfile</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">setup_from_cfg</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>


<div class="viewcode-block" id="MFsetupMixin.setup_from_cfg">
<a class="viewcode-back" href="../../api/mfsetup.mfmodel.html#mfsetup.mfmodel.MFsetupMixin.setup_from_cfg">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setup_from_cfg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a model from scratch, using information in a configuration dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cfg : dict</span>
<span class="sd">            Configuration dictionary, as produced by the model.load_cfg method.</span>
<span class="sd">        verbose : bool</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        m : model instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">name</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Setting up </span><span class="si">{</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;modelname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> model&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cfg_filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; from configuration in </span><span class="si">{</span><span class="n">cfg_filename</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">)</span> <span class="c1">#, **kwargs)</span>

        <span class="c1"># make a grid if one isn&#39;t already specified</span>
        <span class="k">if</span> <span class="s1">&#39;grid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">m</span><span class="o">.</span><span class="n">setup_grid</span><span class="p">()</span>

        <span class="c1"># establish time discretization, including TDIS setup for MODFLOW-6</span>
        <span class="n">m</span><span class="o">.</span><span class="n">setup_tdis</span><span class="p">()</span>

        <span class="c1"># set up the solver</span>
        <span class="n">m</span><span class="o">.</span><span class="n">setup_solver</span><span class="p">()</span>

        <span class="c1"># set up all of the packages specified in the config file</span>
        <span class="n">m</span><span class="o">.</span><span class="n">setup_packages</span><span class="p">(</span><span class="n">reset_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># LGR inset model(s)</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">inset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">inset</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">_is_lgr</span><span class="p">:</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">setup_packages</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">setup_simulation_mover</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">setup_lgr_exchanges</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finished setting up model in </span><span class="si">{:.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">m</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2024, Modflow-setup developers |.
      <span class="lastupdated">Last updated on Jan 17, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>